# Chapter 6 - Exploit Development

> _Security risks at the application level are among the most significant, pervasive categories of security problems impacting organizations today. But traditional IT security focuses on network and perimeter-based protection, not on the application code itself.And while most development teams test their applications for functionality, performance, and integration, the lack of security testing early in the development process can have serious consequences. Failure to address security throughout the application lifecycle can result in embarrassment—or catastrophic damages like the loss of intellectual property, money, or data._
>
> _**— **_**Buffer Overflow Attacks: Detect, Exploit, Prevent, page 403**

## Resources

##### Understanding programs in memory

[Anatomy of a program in memory](http://duartes.org/gustavo/blog/post/anatomy-of-a-program-in-memory/)

[Journey to the stack](http://duartes.org/gustavo/blog/post/journey-to-the-stack/)

[Epilogue: Canaries and Buffer Overflows](http://duartes.org/gustavo/blog/post/epilogues-canaries-buffer-overflows/)

##### Intro to Assembly

[Writing ARM Assembly Part 1](https://azeria-labs.com/writing-arm-assembly-part-1/)

[Assembly - SkullSecurity](https://wiki.skullsecurity.org/index.php?title=Fundamentals)

[x86 Assembly Crash Course](https://www.youtube.com/watch?v=75gBFiFtAb8)

[Assembly Language MegaPrimer for Linux](http://www.securitytube.net/groups?operation=view&groupId=5)

##### Intro to Buffer Overflows

[Intro to Buffer Overflows - Computerphile](https://www.youtube.com/watch?v=1S0aBV-Waeo)

##### Resources

[LiveOverflow's YouTube Channel](https://www.youtube.com/channel/UClcE-kVhqyiHCcjYwcpfj9w)

[https://monosource.github.io/2016/10/radare2-peda](https://monosource.github.io/2016/10/radare2-peda)

[http://www.ragestorm.net/blogs/?p=107](http://www.ragestorm.net/blogs/?p=107)

[http://0xdabbad00.com/wp-content/uploads/2013/04/exploit\_mitigation\_kill\_chain.pdf](http://0xdabbad00.com/wp-content/uploads/2013/04/exploit_mitigation_kill_chain.pdf)

[https://github.com/Microsoft/MSRC-Security-Research/tree/master/presentations](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[http://wiki.osdev.org/Stack\_Smashing\_Protector](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[https://www.youtube.com/watch?v=qj79Qdmw0Pk](https://www.youtube.com/watch?v=qj79Qdmw0Pk)

[https://www.youtube.com/watch?v=FEXnJKXYoLM](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[http://bitblaze.cs.berkeley.edu/papers/diffslicing\_oakland11.pdf](http://bitblaze.cs.berkeley.edu/papers/diffslicing_oakland11.pdf)

[http://www.vividmachines.com/shellcode/shellcode.html](http://www.vividmachines.com/shellcode/shellcode.html)

[https://www.exploit-db.com/docs/17065.pdf](https://www.exploit-db.com/docs/17065.pdf)

[http://blog.cdleary.com/2011/08/understanding-jit-spray/](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[http://www.semantiscope.com/research/BHDC2010/BHDC-2010-Paper.pdf](http://www.semantiscope.com/research/BHDC2010/BHDC-2010-Paper.pdf)

[https://dl.packetstormsecurity.net/papers/shellcode/Writing-JIT-Spray-Shellcode.pdf](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[https://www.usenix.org/legacy/events/sec09/tech/slides/sotirov.pdf](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

##### Intel

> ###### Registers

```
EAX - Accumulator
    Holds return value usually
EBX - Accumulator
    Base Calculations (Arrays, Pointers into Arrays of objects)
ECX - Count / Accumulator
EDX - Data I/O Pointer
ESI - Source index
    for source of string / array operands
EDI - Destination index
    for dest of string / array opperands
EIP - Instruction Pointer
    Points to next instruction
ESP - Stack Pointer
    Points to the top of the stack
EBP - Stack Base Pointer
    Points to the base of the stack
```

> ###### Instructions

```
mov - define
jmp - jump to address
call - jump to address and push exec address to stack
ret - pop the first value off stack and jumps to it
push - decrements stack pointer and saves new operand
pop - sets the operand to the value of the stack, then increments
```

## Buffer Overflows

##### Setup & Information

> ###### Check ASLR/DEP

```
# Linux
Kali> checksec filename

# Windows
https://github.com/PowerShellMafia/PowerSploit
C:\> Get-PESecurity -file "filename"
```

> ###### Disable/Enable ASLR/DEP

```
# Linux
Kali> echo 0 > /proc/sys/kernel/randomize_va_space
Kali> echo 2 > /proc/sys/kernel/randomize_va_space

# Windows
https://support.microsoft.com/en-us/help/2458544/the-enhanced-mitigation-experience-toolkit
http://icompile.eladkarako.com/disable-aslr/
```

> ###### See what shared libs a program uses

```
# Linux
Kali> ldd filename
```

> ###### Find hex addresses of functions/libs within a program

```
# Linux
Kali> readelf -s /lib/i386-linux-gnu/libc.so.6 | grep system
Kali> strings -a -t x /lib/i386-linux-gnu/libc.so.6 | grep /bin/s
```

> ###### Automation

[https://travisf.net/brain-repl-writeup\#running-the-binary-in-gdb](https://travisf.net/brain-repl-writeup#running-the-binary-in-gdb)

##### Attack Vectors

> ###### Integer-based

[https://www.youtube.com/watch?v=d6BU8DWxb3c](https://www.youtube.com/watch?v=d6BU8DWxb3c)

> ###### Stack-based

Overflow input to overwrite EIP with return address that leads to payload

[http://ch3rn0byl.com/intro-to-buffer-overflows/](http://ch3rn0byl.com/intro-to-buffer-overflows/)

[http://www.thegreycorner.com/2010/01/beginning-stack-based-buffer-overflow.html](http://www.thegreycorner.com/2010/01/beginning-stack-based-buffer-overflow.html)

[https://www.corelan.be/index.php/2009/07/19/exploit-writing-tutorial-part-1-stack-based-overflows/](https://www.corelan.be/index.php/2009/07/19/exploit-writing-tutorial-part-1-stack-based-overflows/)

[https://avicoder.me/2016/02/01/smashsatck-revived/](https://avicoder.me/2016/02/01/smashsatck-revived/)

[https://www.youtube.com/watch?v=1S0aBV-Waeo](https://www.youtube.com/watch?v=1S0aBV-Waeo)

[https://www.youtube.com/watch?v=4HxUmbOcN6Y](https://www.youtube.com/watch?v=4HxUmbOcN6Y)

[https://www.youtube.com/watch?v=MMm0I2Dj51A](https://www.youtube.com/watch?v=MMm0I2Dj51A)

[https://www.youtube.com/watch?v=KGzHcqJV-QM](https://www.youtube.com/watch?v=KGzHcqJV-QM)

[http://www.whitelist1.com/2016/11/xstack-overflow-1-exploiting-slmail.html](http://www.whitelist1.com/2016/11/xstack-overflow-1-exploiting-slmail.html)

[http://www.fuzzysecurity.com/tutorials/expDev/1.html](http://www.fuzzysecurity.com/tutorials/expDev/1.html)

[http://www.fuzzysecurity.com/tutorials/expDev/9.html](http://www.fuzzysecurity.com/tutorials/expDev/9.html)

[http://www.thegreycorner.com/2010/01/windows-buffer-overflow-tutorial.html](http://www.thegreycorner.com/2010/01/windows-buffer-overflow-tutorial.html)

###### 

> ###### SEH-based

###### Overflow input to overwrite SEH -&gt; next SEH -&gt; Pop pop ret

[http://www.thegreycorner.com/2010/01/seh-stack-based-windows-buffer-overflow.html](http://www.thegreycorner.com/2010/01/seh-stack-based-windows-buffer-overflow.html)

[http://ch3rn0byl.com/stacks-and-handlers-and-python/](http://ch3rn0byl.com/stacks-and-handlers-and-python/)

[http://www.primalsecurity.net/0x3-exploit-tutorial-buffer-overflow-seh-bypass/](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

> ###### Heap-based

Overflow input to overwrite heap with dummy data, 2nd chunk overwrite forward link with destination and backwards link with value

[https://heap-exploitation.dhavalkapil.com/introduction.html](https://heap-exploitation.dhavalkapil.com/introduction.html)

[http://www.thegreycorner.com/2010/01/heap-spray-exploit-tutorial-internet.html](http://www.thegreycorner.com/2010/01/heap-spray-exploit-tutorial-internet.html)

[https://github.com/DhavalKapil/heap-exploitation](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[https://www.corelan.be/index.php/2011/12/31/exploit-writing-tutorial-part-11-heap-spraying-demystified/](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[http://www.debasish.in/2015/02/walking-heap-using-pydbg.html](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[https://sean.heelan.io/2016/05/31/tracking-down-heap-overflows-with-rr/](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[https://www.youtube.com/watch?v=HPDBOhiKaD8](https://www.youtube.com/watch?v=HPDBOhiKaD8)

[https://www.youtube.com/watch?v=TfJrU95q1J4](https://www.youtube.com/watch?v=TfJrU95q1J4)

[https://github.com/shellphish/how2heap](https://github.com/shellphish/how2heap)

[http://www.fuzzysecurity.com/tutorials/mr\_me/2.html](http://www.fuzzysecurity.com/tutorials/mr_me/2.html)

> ###### Double-free

Memory freed twice. corrupts heap memory manager.

1\) chunk must be isolated \( no freed adjacent chunks \)

2\) destination free list bin must be empty

Forward/Backward pointers both point to base of heap, and the heap points back to the node \(self referential\) infinite loop. \(unlink fails\)

deprecated but still works with some creativity

If heap falls into this state you may be able to use after free or another buffer overflow.

[https://www.youtube.com/watch?v=ZHghwsTRyzQ](https://www.youtube.com/watch?v=ZHghwsTRyzQ)

[https://www.youtube.com/watch?v=gL45bjQvZSU](https://www.youtube.com/watch?v=gL45bjQvZSU)

[https://www.youtube.com/watch?v=HWhzH--89UQ](https://www.youtube.com/watch?v=HWhzH--89UQ)

[https://www.youtube.com/watch?v=sJPhsE\_XeKI](https://www.youtube.com/watch?v=sJPhsE_XeKI)

[https://www.youtube.com/watch?v=ANIoQXAoyr0](https://www.youtube.com/watch?v=ANIoQXAoyr0)

> ###### Memory Corruption

Using memory corruption to leak sensitive data Fuzz the inputs and observe all possible changes in the program Note any oddities and changes \(Especially a dump of bytes! ;\)\)

[https://www.youtube.com/watch?v=SstD1O4\_kwc](https://www.youtube.com/watch?v=SstD1O4_kwc)

> ###### Return to libc

[https://github.com/niklasb/libc-database](https://github.com/niklasb/libc-database)

[https://www.exploit-db.com/docs/28553.pdf](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[https://www.youtube.com/watch?v=m17mV24TgwY](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[http://www.securitytube.net/video/257](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[http://hovav.net/dist/geometry.pdf](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[https://sploitfun.wordpress.com/2015/02/10/understanding-glibc-malloc/](https://sploitfun.wordpress.com/2015/02/10/understanding-glibc-malloc/)

[http://www.cs.dartmouth.edu/~sergey/cs108/2010/subversiveld.pdf](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[https://www.technovelty.org/linux/plt-and-got-the-key-to-code-sharing-and-dynamic-libraries.html](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

> ###### DRAM

[https://googleprojectzero.blogspot.com/2015/03/exploiting-dram-rowhammer-bug-to-gain.html](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

> ###### SIGRETURN Oriented Programming

[https://subs.emis.de/LNI/Proceedings/Proceedings259/2077.pdf](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

> ###### Jump Oriented Programming

[https://www.comp.nus.edu.sg/~liangzk/papers/asiaccs11.pdf](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

> ###### Return Oriented Programming

[https://crypto.stanford.edu/~blynn/rop/](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[https://www.youtube.com/watch?v=5FJxC59hMRY](https://www.youtube.com/watch?v=5FJxC59hMRY)

[http://shell-storm.org/talks/ROP\_course\_lecture\_jonathan\_salwan\_2014.pdf](http://shell-storm.org/talks/ROP_course_lecture_jonathan_salwan_2014.pdf)

[https://www.exploit-db.com/docs/28479.pdf](https://www.exploit-db.com/docs/28479.pdf)

[http://security.cs.rpi.edu/courses/binexp-spring2015/lectures/11/07\_lecture.pdf](http://security.cs.rpi.edu/courses/binexp-spring2015/lectures/11/07_lecture.pdf)

[http://nicholas.carlini.com/papers/2014\_usenix\_ropattacks.pdf](http://nicholas.carlini.com/papers/2014_usenix_ropattacks.pdf)

[https://en.wikipedia.org/wiki/Return-oriented\_programming](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[https://www.youtube.com/watch?v=yS9pGmY\_xuo](https://www.youtube.com/watch?v=yS9pGmY_xuo)

[https://dkalemis.wordpress.com/2010/10/27/the-need-for-a-pop-pop-ret-instruction-sequence/](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[https://medium.com/@iseethieves/intro-to-rop-rop-emporium-split-9b2ec6d4db08](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[https://ropemporium.com/](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[https://www.youtube.com/watch?v=\_3uBybBpq48](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[http://codearcana.com/posts/2013/05/28/introduction-to-return-oriented-programming-rop.html](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[https://0x00sec.org/t/srop-signals-you-say/2890](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[https://www.cs.uic.edu/~s/papers/noret\_ccs2010/noret\_ccs2010.pdf](https://www.cs.uic.edu/~s/papers/noret_ccs2010/noret_ccs2010.pdf)

[http://www.scs.stanford.edu/~sorbo/brop/](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

> ###### EggHunting

The art of searching memory

[http://ch3rn0byl.com/egghunting-sorcery/](http://ch3rn0byl.com/egghunting-sorcery/)

[http://www.thegreycorner.com/2010/02/windows-buffer-overflow-tutorial.html](http://www.thegreycorner.com/2010/02/windows-buffer-overflow-tutorial.html)

[https://www.exploit-db.com/docs/18482.pdf](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

##### Security Mechanisms

> ###### Stack Canaries/Cookies

[https://en.wikipedia.org/wiki/Buffer\_overflow\_protection\#Canaries](https://en.wikipedia.org/wiki/Buffer_overflow_protection#Canaries)

[https://www.rapid7.com/resources/mitigating-buffer-overflow-attacks-with-stack-cookies/](https://www.rapid7.com/resources/mitigating-buffer-overflow-attacks-with-stack-cookies/)

[https://www.youtube.com/watch?v=4HxUmbOcN6Y](https://www.youtube.com/watch?v=4HxUmbOcN6Y)

[https://www.corelan.be/index.php/2009/09/21/exploit-writing-tutorial-part-6-bypassing-stack-cookies-safeseh-hw-dep-and-aslr/](https://www.corelan.be/index.php/2009/09/21/exploit-writing-tutorial-part-6-bypassing-stack-cookies-safeseh-hw-dep-and-aslr/)

[https://xorl.wordpress.com/2010/10/14/linux-glibc-stack-canary-values/](https://xorl.wordpress.com/2010/10/14/linux-glibc-stack-canary-values/)

[https://www.elttam.com.au/blog/playing-with-canaries/](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

> ###### NX/DEP

[https://en.wikipedia.org/wiki/Executable\_space\_protection](https://en.wikipedia.org/wiki/Executable_space_protection)

[https://reverseengineering.stackexchange.com/questions/9336/can-mprotect-set-the-stack-itself-as-executable](https://reverseengineering.stackexchange.com/questions/9336/can-mprotect-set-the-stack-itself-as-executable)

> ###### ASLR

[https://en.wikipedia.org/wiki/Address\_space\_layout\_randomization](https://en.wikipedia.org/wiki/Address_space_layout_randomization)

[http://www.abatchy.com/2017/06/exploit-dev-101-bypassing-aslr-on.html](http://www.abatchy.com/2017/06/exploit-dev-101-bypassing-aslr-on.html)

[https://decoder.cloud/2017/06/15/simple-aslrnx-bypass-on-a-linux-32-bit-binary/](https://decoder.cloud/2017/06/15/simple-aslrnx-bypass-on-a-linux-32-bit-binary/)

[http://hmarco.org/bugs/linux-ASLR-integer-overflow.html](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[https://www.blackhat.com/presentations/bh-europe-09/Fritsch/Blackhat-Europe-2009-Fritsch-Bypassing-aslr-whitepaper.pdf](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

## Information Disclosure

##### Format Strings

> ###### Resources

```
%d, %i - signed decimal
%u - unsigned decimal
%o - unsigned octal
%x - unsigned hexadecimal int
%X - unsigned hexadecimal int (UPPERCASE)
%f - decimal float
%e - scientific notation
%a - hexadecimal floating point
%c - char
%s - string
%p - pointer address
%n - writes bytes to memory address

will pop off stack until all are satisfied or segfault

# printf
prints values on the stack in hex
printed in human friendly in little-endian
view arbitrary memory locations
move argument pointer far enough forward to point within the string (%x chain)
printf("\xd3\x4d\xb3\x3f%x%x%x%x%s")
dereferences so you get string form

printf("hello%n\n", (int *)&i); // write 5 to i
printf("\xd3\x4d\xb3\x3f%x%x%x%150x%n"); // write 150 to it
```

[https://www.youtube.com/watch?v=MBz5C9Wa6KM](https://www.youtube.com/watch?v=MBz5C9Wa6KM)

[https://www.youtube.com/watch?v=XuzuFUGuQv0](https://www.youtube.com/watch?v=XuzuFUGuQv0)

[https://www.youtube.com/watch?v=t1LH9D5cuK4](https://www.youtube.com/watch?v=t1LH9D5cuK4)

[https://www.youtube.com/watch?v=fRgNtGXDMlY](https://www.youtube.com/watch?v=fRgNtGXDMlY)

[https://www.youtube.com/watch?v=0WvrSfcdq1I](https://www.youtube.com/watch?v=0WvrSfcdq1I)

[https://barrebas.github.io/blog/2015/02/22/maximum-overkill-two-from-format-string-vulnerability-to-remote-code-execution/](https://barrebas.github.io/blog/2015/02/22/maximum-overkill-two-from-format-string-vulnerability-to-remote-code-execution/)

[https://www.exploit-db.com/docs/28476.pdf](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

[https://rh0dev.github.io/blog/2015/fun-with-info-leaks/](https://www.gitbook.com/book/dostoevskylabs/dostoevskylabs-pentest-notes/edit#)

## Deserialization

##### PHP

> ###### Resources

[https://www.youtube.com/watch?v=\_Zj0B4D4TYc](https://www.youtube.com/watch?v=_Zj0B4D4TYc)

[https://www.notsosecure.com/remote-code-execution-via-php-unserialize/](https://www.notsosecure.com/remote-code-execution-via-php-unserialize/)

##### Java

> ###### Resources

[https://www.youtube.com/watch?v=v78bAn1-vqA](https://www.youtube.com/watch?v=v78bAn1-vqA)

##### nodejs

> ###### Resources

[https://opsecx.com/index.php/2017/02/08/exploiting-node-js-deserialization-bug-for-remote-code-execution/](https://opsecx.com/index.php/2017/02/08/exploiting-node-js-deserialization-bug-for-remote-code-execution/)

## 



